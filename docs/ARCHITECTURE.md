# Hermes CRM - Архитектурная документация

## Обзор

Hermes – это модульная CRM-система, построенная на принципах модульного монолита с использованием Next.js для фронтенда и NestJS для бэкенда. Архитектура спроектирована для высокой масштабируемости, модульности и возможности будущего перехода к микросервисам.

## Технологический стек

### Фронтенд
- **Next.js 14** - React фреймворк с App Router
- **TypeScript** - типизированный JavaScript
- **Tailwind CSS** - utility-first CSS фреймворк
- **React Query** - управление состоянием и кэшированием
- **React Hook Form** - управление формами
- **next-intl** - интернационализация

### Бэкенд
- **NestJS** - Node.js фреймворк с TypeScript
- **TypeORM** - ORM для работы с базой данных
- **PostgreSQL** - основная база данных
- **Redis** - кэширование и сессии
- **JWT** - аутентификация
- **nestjs-i18n** - интернационализация

## Архитектурные принципы

### 1. Модульность
Каждый домен системы выделен в отдельный модуль:
- **Auth** - аутентификация и авторизация
- **Leads** - управление лидами
- **Offers** - управление офферами
- **Redirects** - система редиректов
- **RedirectAnalytics** - аналитика редиректов
- **Dashboard** - дашборд и общая аналитика
- **KeitaroIntegration** - интеграция с Keitaro

### 2. Изоляция бизнес-логики
- Каждый модуль инкапсулирует свою логику
- Взаимодействие между модулями через четко определенные интерфейсы
- Минимальная связанность между модулями

### 3. Чистая архитектура
- Разделение на слои (контроллеры, сервисы, репозитории)
- Dependency Injection для управления зависимостями
- Использование DTO для валидации данных

### 4. Масштабируемость
- Модульный монолит с возможностью выделения в микросервисы
- Горизонтальное масштабирование
- Кэширование и оптимизация производительности

## Структура проекта

```
hermes/
├── frontend/                 # Next.js приложение
│   ├── src/
│   │   ├── app/             # App Router страницы
│   │   ├── components/      # React компоненты
│   │   ├── lib/            # Утилиты и конфигурация
│   │   └── types/          # TypeScript типы
│   ├── public/             # Статические файлы
│   └── package.json
├── backend/                 # NestJS приложение
│   ├── src/
│   │   ├── modules/        # Доменные модули
│   │   ├── common/         # Общие компоненты
│   │   ├── i18n/          # Переводы
│   │   └── main.ts        # Точка входа
│   └── package.json
├── shared/                  # Общие типы и утилиты
│   ├── src/
│   │   ├── auth/          # Типы аутентификации
│   │   ├── leads/         # Типы лидов
│   │   ├── offers/        # Типы офферов
│   │   ├── redirects/     # Типы редиректов
│   │   ├── analytics/     # Типы аналитики
│   │   ├── keitaro/       # Типы интеграции
│   │   └── common/        # Общие типы
│   └── package.json
└── docs/                   # Документация
```

## Модули бэкенда

### Auth Module
**Ответственность**: Аутентификация и авторизация пользователей

**Компоненты**:
- `AuthController` - REST API эндпоинты
- `AuthService` - бизнес-логика аутентификации
- `JwtStrategy` - JWT стратегия для Passport
- `User` - сущность пользователя

**API эндпоинты**:
- `POST /api/auth/login` - вход в систему
- `POST /api/auth/refresh` - обновление токена
- `GET /api/auth/me` - получение профиля пользователя

### Leads Module
**Ответственность**: Управление лидами

**Компоненты**:
- `LeadsController` - REST API эндпоинты
- `LeadsService` - бизнес-логика работы с лидами
- `Lead` - сущность лида
- `LeadHistory` - история изменений лида

**API эндпоинты**:
- `GET /api/leads` - список лидов с фильтрацией
- `POST /api/leads` - создание лида
- `PUT /api/leads/:id` - обновление лида
- `DELETE /api/leads/:id` - удаление лида

### Offers Module
**Ответственность**: Управление офферами

**Компоненты**:
- `OffersController` - REST API эндпоинты
- `OffersService` - бизнес-логика работы с офферами
- `Offer` - сущность оффера

**API эндпоинты**:
- `GET /api/offers` - список офферов
- `POST /api/offers` - создание оффера
- `PUT /api/offers/:id` - обновление оффера
- `DELETE /api/offers/:id` - удаление оффера

### Redirects Module
**Ответственность**: Система редиректов и правил

**Компоненты**:
- `RedirectsController` - REST API эндпоинты
- `RedirectsService` - логика применения правил редиректов
- `Redirect` - сущность редиректа
- `RedirectRule` - правила редиректов

**API эндпоинты**:
- `GET /api/redirects` - список редиректов
- `POST /api/redirects` - создание редиректа
- `POST /api/redirects/apply` - применение правил редиректа

### RedirectAnalytics Module
**Ответственность**: Аналитика редиректов

**Компоненты**:
- `RedirectAnalyticsController` - REST API эндпоинты
- `RedirectAnalyticsService` - логика аналитики
- `RedirectEvent` - события редиректов

**API эндпоинты**:
- `GET /api/analytics/redirects` - статистика редиректов
- `GET /api/analytics/redirects/:id` - детальная статистика

### Dashboard Module
**Ответственность**: Дашборд и общая аналитика

**Компоненты**:
- `DashboardController` - REST API эндпоинты
- `DashboardService` - агрегация данных для дашборда

**API эндпоинты**:
- `GET /api/dashboard/stats` - общая статистика
- `GET /api/dashboard/charts` - данные для графиков

### KeitaroIntegration Module
**Ответственность**: Интеграция с Keitaro

**Компоненты**:
- `KeitaroController` - обработка вебхуков
- `KeitaroService` - взаимодействие с Keitaro API
- `KeitaroWebhook` - обработка входящих данных

**API эндпоинты**:
- `POST /api/keitaro/webhook` - вебхук от Keitaro
- `GET /api/keitaro/stats` - статистика из Keitaro

## Фронтенд архитектура

### App Router структура
```
src/app/
├── (auth)/              # Группа маршрутов аутентификации
│   ├── login/
│   └── register/
├── (dashboard)/         # Группа маршрутов дашборда
│   ├── dashboard/
│   ├── leads/
│   ├── offers/
│   ├── redirects/
│   └── analytics/
├── layout.tsx           # Корневой layout
└── page.tsx            # Главная страница
```

### Компоненты
- **Layout** - общий layout с навигацией
- **Sidebar** - боковая панель навигации
- **Header** - верхняя панель
- **DataTable** - переиспользуемая таблица данных
- **Form** - компоненты форм
- **Modal** - модальные окна

### Управление состоянием
- **React Query** - для серверного состояния
- **React Context** - для глобального состояния приложения
- **React Hook Form** - для состояния форм

## Интеграция с Keitaro

### API интеграция
- Получение статистики по кампаниям
- Синхронизация офферов
- Получение данных о кликах и конверсиях

### Вебхуки
- Обработка конверсий в реальном времени
- Обновление статусов лидов
- Синхронизация данных

### Постбэки
- Отправка данных о конверсиях в Keitaro
- Обновление статистики

## Безопасность

### Аутентификация
- JWT токены для аутентификации
- Refresh токены для обновления сессий
- HttpOnly cookies для хранения токенов

### Авторизация
- Role-based access control (RBAC)
- Два уровня ролей: SUPERADMIN и ADMIN
- Защита эндпоинтов по ролям

### Валидация данных
- Class-validator для валидации DTO
- Глобальные фильтры исключений
- Санитизация входных данных

## Производительность

### Кэширование
- Redis для кэширования данных
- Кэширование запросов к API
- Кэширование переводов

### Оптимизация
- Пагинация для больших списков
- Ленивая загрузка компонентов
- Оптимизация изображений

### Мониторинг
- Логирование запросов
- Метрики производительности
- Обработка ошибок

## Развертывание

### Разработка
```bash
# Установка зависимостей
npm install

# Запуск в режиме разработки
npm run dev
```

### Продакшн
- Docker контейнеры для каждого сервиса
- Nginx для проксирования запросов
- PostgreSQL и Redis для данных
- Мониторинг через Prometheus/Grafana

## Будущие улучшения

### Микросервисы
- Выделение модулей в отдельные сервисы
- API Gateway для маршрутизации
- Event-driven архитектура

### Расширения
- Модуль поддержки клиентов
- Интеграция с телефонными системами
- Мобильное приложение

### Аналитика
- Машинное обучение для предсказания конверсий
- Расширенная аналитика поведения пользователей
- A/B тестирование редиректов 